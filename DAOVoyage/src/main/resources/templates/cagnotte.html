<!DOCTYPE html>
<html th:replace="~{ fragments/layout.html :: layout('Cagnotte', ~{ ::body }) }">
	<body id="body" class="container-fluid">
	
	<!--------------------------------- Creation ---------------------------------
	------------------------------------------------------------------------------
	------------------------------------------------------------------------------
	----------------------------------------------------------------------------->
		<div th:if="${ aAfficher == 'creation' }">
			<h1>Création d'une cagnotte</h1><br/>
			<div class="row">
				<div class="col-6">
					<div>
						<label>Client Initiateur</label>
						<input class="form-control" type="text" th:placeholder="[[ ${ #authentication.name } ]]" readonly />
					</div></br>
					
					<form class="form-group" method="POST" action="cagnotte">
						<div class="form-group">
							<label>Client Destinataire</label>
							<input name="loginDestinataire" type="text" class="form-control" id="loginDest" aria-describedby="emailHelp">
							<div th:if="${ cagnotteSuccess == 'N' }">
								<font color="red">Ce destinataire n'existe pas</font>
							</div>
						</div>
						<div>
							<label><u>Choisir le voyage à offrir</u></label><br>
							<input type="hidden" name="action" value="creation"/>
							<input type="hidden" name="action2" value="creationCagnotte"/>
							
							Ville de départ
							<select required id="v1" name="v1" class="form-control formWidth">
								<option disabled selected value="N">Sélectionnez une ville de départ</option>
								<option th:each="v : ${ villes }" th:value="${v.nom}">[[ ${ v.nom } ]]</option>
							</select>
							
							Ville d'arrivée
							<select id="v2" name="v2" class="form-control formWidth">
								<option selected value="N">Toutes</option>
							</select>
							
							Moyen de transport
							<select id="t" name="t" class="form-control formWidth">
								<option selected value="N">Tous</option>
							</select>
							
							<div id="rechercheButton" class="col-12">
								<input class="btn btn-info creer" type="submit" value="Créer une cagnotte">
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>		
	

	
	
	<!--------------------------------- Participation ----------------------------
	------------------------------------------------------------------------------
	------------------------------------------------------------------------------
	----------------------------------------------------------------------------->
	
	<div th:if="${ aAfficher == 'participation' }">
		<h1>Participation à une cagnotte</h1><br/>
		<div class="row">
			<div class="col-6">
				<form method="POST" action="cagnotte">
					<div class="form-group">
						<label>Login du destinataire de la cagnotte</label>
						<input name="loginDestinataire" type="text" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">
						<input type="hidden" name="action" value="participation"/>
						<input type="hidden" name="action2" value="participationCagnotte"/>
						<div th:if="${ checkLogin == 'N' }">
							<font color="red">Pas de cagnotte en cours pour ce client !</font>
						</div>
					</div>
					<button type="submit" class="btn btn-info">Submit</button>
				</form>
			</div>	<br/>
					
			<div class="col-12">	
				<table th:if="${ checkLogin == 'Y' }" class="table tableau">
					<thead class="thead-dark">
						<tr>
							<td><strong>Participer</strong></td>
							<td><strong>Initiateur</strong></td>
							<td><strong>Ville de départ</strong></td>
							<td><strong>Ville d'arrivée</strong></td>
							<td><strong>Moyen de transport</strong></td>
							<td><strong>Durée</strong></td>
							<td><strong>Somme restante</strong></td>
						</tr>
					</thead>
		
						<tr th:each="c : ${ cagnottesDestinataire }">
							<td> 
								<form method="POST" action="cagnotte">
									<input type="number" step="0.01" th:max="${ c.sommeAPayer }" required placeholder="somme" name="sommePayee" /> 
									<input type="hidden" name="action" value="sommePayee" />
									<input type="hidden" name="cagnotteChoisie" th:value="${c.id}" />
									<input type="submit" class="btn btn-outline-info" value="Crediter" />
								</form>
							</td>
							<td>[[ ${ c.initiateur.login } ]]</td>
							<td>[[ ${ c.voyage.v1.nom } ]]</td>
							<td>[[ ${ c.voyage.v2.nom } ]]</td>
							<td>[[ ${ c.voyage.t.nom } ]]</td>
							<td>[[ ${ c.voyage.duree } ]]</td>
							<td>[[ ${ c.sommeAPayer } ]] €</td>
						</tr>
				</table> <br/>
			</div>
			</div>	
		</div>
		
	<!--------------------------------- Archives ---------------------------------
	------------------------------------------------------------------------------
	------------------------------------------------------------------------------
	----------------------------------------------------------------------------->
		<div th:if="${ aAfficher == 'archives' }">
			<h1>Voici vos différentes cagnotes</h1><br/>
			<label><u>Cagnottes dont vous avez été le destinataire</u></label>
			<table class="table tableau">
				<thead class="thead-dark">
					<tr>
						<td><strong>Initiateur</strong></td>
						<td><strong>Ville de départ</strong></td>
						<td><strong>Ville d'arrivée</strong></td>
						<td><strong>Moyen de transport</strong></td>
						<td><strong>Durée</strong></td>
						<td><strong>Participants</strong></td>
					</tr>
				</thead>

				<tr th:each="c : ${ session.client.cagnottesDestinataire }">
					<td>[[ ${ c.initiateur.login } ]]</td>
					<td>[[ ${ c.voyage.v1.nom } ]]</td>
					<td>[[ ${ c.voyage.v2.nom } ]]</td>
					<td>[[ ${ c.voyage.t.nom } ]]</td>
					<td>[[ ${ c.voyage.duree } ]]</td>
					<td>
						<div th:each="p : ${ c.participants }">
							[[ ${ p.login } ]]<br/>
						</div>
					</td>
				</tr>
			</table> <br/>
			
			<label><u>Cagnottes dont vous êtes l'initiateur</u></label>
			<table class="table tableau">
				<thead class="thead-dark">
					<tr>
						<td><strong>Destinataire</strong></td>
						<td><strong>Ville de départ</strong></td>
						<td><strong>Ville d'arrivée</strong></td>
						<td><strong>Moyen de transport</strong></td>
						<td><strong>Durée</strong></td>
						<td><strong>Participants</strong></td>
					</tr>
				</thead>

				<tr th:each="c : ${ session.client.cagnottesInitiateur }">
					<td>[[ ${ c.destinataire.login } ]]</td>
					<td>[[ ${ c.voyage.v1.nom } ]]</td>
					<td>[[ ${ c.voyage.v2.nom } ]]</td>
					<td>[[ ${ c.voyage.t.nom } ]]</td>
					<td>[[ ${ c.voyage.duree } ]]</td>
					<td>
						<div th:each="p : ${ c.participants }">
							[[ ${ p.login } ]]<br/>
						</div>
					</td>
				</tr>
			</table> <br/>
			
			<label><u>Cagnottes dont vous avez été paticipants</u></label>
			<table class="table tableau">
				<thead class="thead-dark">
					<tr>
						<td><strong>Destinataire</strong></td>
						<td><strong>Initiateur</strong></td>
						<td><strong>Ville de départ</strong></td>
						<td><strong>Ville d'arrivée</strong></td>
						<td><strong>Moyen de transport</strong></td>
						<td><strong>Durée</strong></td>
						<td><strong>Participants</strong></td>
					</tr>
				</thead>

				<tr th:each="c : ${ session.client.cagnottesParticipant }">
					<td>[[ ${ c.destinataire.login } ]]</td>
					<td>[[ ${ c.initiateur.login } ]]</td>
					<td>[[ ${ c.voyage.v1.nom } ]]</td>
					<td>[[ ${ c.voyage.v2.nom } ]]</td>
					<td>[[ ${ c.voyage.t.nom } ]]</td>
					<td>[[ ${ c.voyage.duree } ]]</td>
					<td>
						<div th:each="p : ${ c.participants }">
							[[ ${ p.login } ]]<br/>
						</div>
					</td>
				</tr>
			</table>
		</div>
		
	<script th:inline="javascript">
	
	var v2 = document.querySelector('[id="v2"]');
	var t = document.querySelector('[id="t"]');

	$('#v1').change(function() {
		
		var l = v2.options.length;
		for (j = 0; j < l; j++) {
			v2.remove(1);}
		
		let ville1 = $('#v1 option:selected').val();
		
		$.ajax('actVille2', {
			type: 'POST',
			data: { v1: ville1
			},
			success: function(liste) {
				var villes2 = JSON.parse(liste);
				
				for (j = 0; j < villes2.length; j++) {
					var c = document.createElement("option");
					c.text = villes2[j].nom;
					v2.options.add(c, j + 1);
				}
			}
		});
		
	});

	
	$('#v2').change(function() {
	
		var lt = t.options.length;
		for(j = 0 ; j < lt ; j++) {
			t.remove(1);}
		
		transports = [];
		
		if(v2.selectedIndex != 0) {
			for (const t of [[${transports}]]) {
				transports.push(t.nom);
			}
		
			for(j = 0 ; j < transports.length ; j++) {
				var c = document.createElement("option");
				c.text = transports[j];
				t.options.add(c, j+1);
			}
		}
	});
	
	$('#loginDest').change(function() {
		
		let loginDest = $('#loginDest').val();
		
		$.ajax('cagnotte/checkLoginDest', {
			type: 'POST',
			data: { loginDest: loginDest
			},
			success: function(error) {
				if (error == "Y"){
					alert("Ce desinataire n'existe pas !")
				}
			}
		});
		
	});
	</script>
		
	</body>
</html>